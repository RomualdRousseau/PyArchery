
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Tutorial 2 - Data extraction with a complex semi-structured layout - PyArchery</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorial-2-data-extraction-with-a-complex-semi-structured-layout" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PyArchery" class="md-header__button md-logo" aria-label="PyArchery" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyArchery
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial 2 - Data extraction with a complex semi-structured layout
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PyArchery" class="md-nav__button md-logo" aria-label="PyArchery" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PyArchery
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup-pyarchery" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup PyArchery
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup PyArchery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#import-the-package" class="md-nav__link">
    <span class="md-ellipsis">
      
        Import the package:
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minimal-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        Minimal code
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-base-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Load base model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Load base model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-the-document" class="md-nav__link">
    <span class="md-ellipsis">
      
        Load the document
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output-the-tabular-result" class="md-nav__link">
    <span class="md-ellipsis">
      
        Output the tabular result
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="tutorial-2-data-extraction-with-a-complex-semi-structured-layout">Tutorial 2 - Data extraction with a complex semi-structured layout</h1>
<p><a href="https://github.com/RomualdRousseau/PyArchery">View source on GitHub</a>.</p>
<p>This tutorial will demonstrate how to use <a href="https://github.com/RomualdRousseau/PyArchery">PyArchery</a> to extract data from
one Excel spreadsheet. To demonstrate the usage of this framework, we will load a document with a somewhat complex
layout, as seen here:</p>
<p><img alt="document with multiple tables" src="../images/tutorial2_data.png" /></p>
<h2 id="setup-pyarchery">Setup PyArchery</h2>
<h3 id="import-the-package">Import the package:</h3>
<pre><code class="language-python">import pyarchery
</code></pre>
<h2 id="minimal-code">Minimal code</h2>
<p>The minimal code to load a document is as follow:</p>
<pre><code class="language-python">with pyarchery.load(file_path, encoding=&quot;UTF-8&quot;) as doc:
    for sheet in doc.sheets():
        table = sheet.getTable()
        if table.isPresent():
            table = table.get()
            doSomethingWithHeaders(table.headers())
            doSomethingWithRows(table.rows())
</code></pre>
<p>The encoding ("UTF-8" here) is used if the encoding could not be detected when loading the document.</p>
<h2 id="load-base-model">Load base model</h2>
<p>To parse a document, PyArchery needs a model that will contains the parameters required to the parsing. Instead to start
/from an empty Model, we will start from an existing one and we will adapt it for our document. You can find a list and details of all models <a href="https://github.com/RomualdRousseau/Archeryarchery-models">here</a>.</p>
<p>The base model, we will use, is "sales-english" that has been trained on 200+ english documents containing distributor
data and with a large range of different layouts.</p>
<p>The base model already recognize some entities such as DATE and NUMBER. We will setup the model to add one new entity
PRODUCTNAME and we will configure a layex to extract the different elements of the documents. You can find more details
about layex.</p>
<pre><code class="language-python">REPO_BASE_URL = &quot;https://raw.githubusercontent.com/RomualdRousseau/Any2Json-Models/main&quot;
MODEL_NAME = &quot;sales-english&quot;
FILE_PATH = &quot;data/document with multiple tables.xlsx&quot;
FILE_ENCODING = &quot;UTF-8&quot;


builder = pyarchery.model_from_uri(f&quot;{REPO_BASE_URL}/{MODEL_NAME}/{MODEL_NAME}.json&quot;)

entities = [v for v in builder.getEntityList() if v != &quot;PACKAGE&quot;]
entities.append(&quot;PRODUCTNAME&quot;)

patterns = {k: v for (k, v) in builder.getPatternMap().items() if v != &quot;PACKAGE&quot;}
patterns[&quot;\\D+\\dml&quot;] = &quot;PRODUCTNAME&quot;

parser = pyarchery.LayexTableParser(
    [&quot;(v.$)+&quot;], [&quot;(()(S+$))(()([/^TOTAL/|v].+$)())+(/TOTAL/.+$)&quot;]
)

model = (
    builder.setEntityList(entities)
    .setPatternMap(patterns)
    .setTableParser(parser)
    .build()
)
</code></pre>
<h3 id="load-the-document">Load the document</h3>
<p>We load the document by creating a document instance with the model and options to parse the document. The hint
"pyarchery.INTELLI_LAYOUT" will tell the document instance that the document has a complex layout. The recipe
"sheet.setCapillarityThreshold(0)" will tell the parser engine to extract the features as <strong><em>small</em></strong> as possible. And finally we want the tag case to be in snake case notation:</p>
<pre><code class="language-python">with pyarchery.load(
    FILE_PATH,
    encoding=FILE_ENCODING,
    model=model,
    hints=[pyarchery.INTELLI_LAYOUT],
    recipe=[&quot;sheet.setCapillarityThreshold(0)&quot;],
    tag_case=&quot;SNAKE&quot;
) as doc:
    ...
</code></pre>
<h3 id="output-the-tabular-result">Output the tabular result</h3>
<p>Finally, we iterate over the sheets, rows and cells and outpout the data on the console:</p>
<pre><code class="language-python">    for sheet in doc.sheets:
        table = sheet.table
        if table:
            print(table.to_arrow().to_pandas().to_markdown())
</code></pre>
<pre><code class="language-bash">|    | a_document_very_important   | date       | productname   | invoice_date        | client   |   qty |   amount |
|---:|:----------------------------|:-----------|:--------------|:--------------------|:---------|------:|---------:|
|  0 | A document very important   | 2023-02-01 | Product 1ml   | 2023-02-01 12:00:00 | AAA      |     1 |      100 |
|  1 | A document very important   | 2023-02-01 | Product 1ml   | 2023-02-01 12:00:00 | BBB      |     1 |      100 |
|  2 | A document very important   | 2023-02-01 | Product 1ml   | 2023-02-01 12:00:00 | BBB      |     3 |      300 |
|  3 | A document very important   | 2023-02-01 | Product 1ml   | 2023-02-01 12:00:00 | AAA      |     1 |      100 |
|  4 | A document very important   | 2023-02-01 | Product 2ml   | 2023-02-01 12:00:00 | AAA      |     1 |      100 |
|  5 | A document very important   | 2023-02-01 | Product 2ml   | 2023-02-01 12:00:00 | BBB      |     2 |      200 |
|  6 | A document very important   | 2023-02-01 | Product 2ml   | 2023-02-01 12:00:00 | CCC      |     4 |      400 |
|  7 | A document very important   | 2023-02-01 | Product 2ml   | 2023-02-01 12:00:00 | DDD      |     1 |      100 |
|  8 | A document very important   | 2023-02-01 | Product 3ml   | 2023-02-01 12:00:00 | AAA      |     1 |      100 |
|  9 | A document very important   | 2023-02-01 | Product 3ml   | 2023-02-01 12:00:00 | CCC      |     1 |      100 |
| 10 | A document very important   | 2023-02-01 | Product 3ml   | 2023-02-01 12:00:00 | AAA      |     1 |      100 |
| 11 | A document very important   | 2023-02-01 | Product 3ml   | 2023-02-01 12:00:00 | DDD      |     1 |      100 |
</code></pre>
<p>On this output, we print out the graph of the document built during the parsing and we can see clearly the relation
between the elements of the spreadsheet and how there are structured in tabular form.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Congratulations! You have loaded documents using PyArchery.</p>
<p>For more examples of using PyArchery, check out the <a href="../">tutorials</a>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>